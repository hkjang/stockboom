# 장애 대응 및 복구 가이드 (Incident Response & Recovery Guide)

## 1. 개요
본 문서는 StockBoom 시스템 운영 중 발생할 수 있는 주요 장애 상황에 대한 대응 절차와 복구 방법을 정의합니다.

## 2. 장애 등급 정의
| 등급 | 정의 | 대응 목표 시간 | 예시 |
|------|------|----------------|------|
| **P1 (Critical)** | 서비스 전면 중단 또는 금전적 손실 위험 | 즉시 (15분 내) | DB 접속 불가, 매매 주문 전체 실패 |
| **P2 (High)** | 주요 기능 일부 작동 불가 | 1시간 내 | 특정 증권사 API 연동 실패, 알림 발송 지연 |
| **P3 (Medium)** | 성능 저하 또는 비핵심 기능 오류 | 4시간 내 | API 응답 속도 저하, 일부 차트 데이터 누락 |
| **P4 (Low)** | 경미한 버그 또는 UI 오류 | 24시간 내 | 오타, UI 깨짐 |

## 3. 주요 장애 시나리오 및 대응

### 3.1 API 응답 지연 또는 타임아웃 (P2/P3)
- **증상**: API 요청 시 504 Gateway Timeout 발생, 응답 시간 2초 이상 지속
- **원인**: DB 락, Redis 부하, 외부 API 지연, 트래픽 급증
- **대응**:
  1. `docker stats`로 리소스 사용량 확인
  2. DB 활성 쿼리 확인 (`pg_stat_activity`) 및 장기 실행 쿼리 중단
  3. Redis 연결 상태 확인
  4. 필요 시 API 컨테이너 스케일 아웃 또는 재시작

### 3.2 매매 주문 실패 (P1)
- **증상**: 주문 상태가 'FAILED' 또는 'REJECTED'로 다수 기록됨
- **원인**: 증권사 API 장애, 토큰 만료, 잔고 부족, 시장 운영 시간 외
- **대응**:
  1. 증권사 API 상태 페이지 또는 공지 확인
  2. 토큰 갱신 API 수동 호출
  3. 실패한 주문의 로그 분석 (`failure_reason` 컬럼 확인)
  4. 시스템 오류인 경우, 버그 수정 후 긴급 배포 및 수동 재주문 검토

### 3.3 큐(Queue) 처리 지연 또는 중단 (P2)
- **증상**: BullMQ 대기열(Waiting) 급증, 작업 처리 속도 저하
- **원인**: Worker 프로세스 다운, Redis 메모리 부족, 처리 로직 버그
- **대응**:
  1. Worker 컨테이너 로그 확인 (에러 발생 여부)
  2. Worker 컨테이너 재시작
  3. Redis 메모리 확보 (불필요한 키 삭제)
  4. 처리 실패한 작업(Failed) 원인 분석 후 재시도(Retry) 또는 삭제

## 4. 복구 및 롤백 (Recovery & Rollback)

### 4.1 배포 롤백
- 신규 배포 후 치명적 오류 발견 시 즉시 이전 버전으로 롤백
- **Docker Compose**: 이미지 태그를 이전 버전으로 변경 후 `up -d` 실행
- **DB 마이그레이션**: `prisma migrate resolve` 등을 통해 스키마 변경 취소 (데이터 손실 주의)

### 4.2 데이터 복구
- **트랜잭션 복구**: 매매 관련 데이터 불일치 시 증권사 원장 데이터와 대조하여 수동 보정
- **백업 복원**: DB 데이터 손상 시 가장 최근 백업본으로 복원 (운영 가이드 3.2 참조)

## 5. 비상 연락망 및 알림 체계
- **장애 감지**: Prometheus/Grafana Alertmanager -> Slack/Email 발송
- **초동 조치**: 온콜(On-call) 엔지니어가 알림 수신 후 10분 내 응답
- **상황 전파**: 장애 등급 P2 이상 시 경영진 및 관련 부서 공유
- **사후 분석**: 장애 해결 후 24시간 내 Post-mortem(사후 회고) 작성 및 재발 방지 대책 수립
